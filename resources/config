#!/bin/bash

# changes server configuration (via server.properties) with a text GUI

source "$HOME/bin/_check" || { echo "error: $HOME/bin/_check not found or readable"; exit 1; }

needscommand dialog

if [[ "$#" -lt 1 ]]; then
    echoerr "too few parameters. Usage: $0 <servername>"
    exit 1
fi


lines=$(($(tput lines)-6))
cols=$(($(tput cols)-6))
menuheight=$(($(tput lines)-20))
servername="$1"
xlabel=3
xitem=30
y=1 # incremental
tmprunfile=/tmp/jeffmc.config.run
tmpanswerfile=/tmp/jeffmc.config.answers
tmpkeysfile=/tmp/jeffmc.config.keys

flen=$((cols-30))
ilen=200

cd "$MCPATH" || {
    echoerr "could not enter $MCPATH"
    exit 1
}

cd "$servername" || {
    echoerr "server $servername not found at $MCPATH/$servername"
    exit 1
}

if [[ ! -f server.properties ]]; then
    echoerr "could not find server.properties at $MCPATH/$servername."
    echoerr "did you start the server at least once?"
    exit 2
fi

array=""
touch $tmpkeysfile || {
    echoerr "could not create file $tmpkeysfile"
    exit 1
}
echo -n "" > $tmpkeysfile

while read line; do
    if [[ ${line:0:1} != '#' ]]; then
        key=$(echo $line | cut -f 1 -d '=')
        value=$(echo $line | cut -f 2 -d '=')
        #array="\"$key\" $y $xlabel \"$value\" $y $xitem $flen $ilen"
        array="$array \"$key\" $y $xlabel \"$value\" $y $xitem $flen $ilen"
        echo $key >> $tmpkeysfile
        y=$((y+1))
    fi
done < server.properties

touch $tmprunfile || {
    echoerr "could not create file $tmprunfile"
    exit 1
}

touch $tmpanswerfile || {
    echoerr "could not create file $tmpanswerfile"
    exit 1
}

echo -n "dialog --title \"JEFF-MC: Server configuration\" --form \"\\nCopyright 2018 JEFFmedia GbR\" $lines $cols $menuheight " > $tmprunfile 
echo -n $array >> $tmprunfile
echo -n " 2> $tmpanswerfile" >> $tmprunfile


bash $tmprunfile
rm -f $tmprunfile

currentline=1 #incremental
while read line; do
    key=$line
    value=$(sed "${currentline}q;d" $tmpanswerfile)
    echo "${key}=${value}"
    currentline=$((currentline+1))
done < $tmpkeysfile
